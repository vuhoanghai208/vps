getgenv().configs = {
    coinFarm = true,
    safeHeight = 100,
    murderDistance = 30,
    coinWaitTime = 2,
    loopDelay = 0.2,
    safeWaitTime = 2,
    resetInterval = 300,
    enableAutoReset = true,
    coinNames = {"Coin_Server"}
}

--!strict
local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local Workspace = game:GetService('Workspace')
local CollectionService = game:GetService('CollectionService')

local localPlayer = Players.LocalPlayer
local PlayerGui = localPlayer:WaitForChild("PlayerGui")

-- UI Hub
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = PlayerGui
ScreenGui.Name = "TheaugHub_MM2"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true

-- Label: V Source Hub
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(0, 200, 0, 40)
TitleLabel.Position = UDim2.new(0, 10, 0, 10)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "⚡ V Source Hub ⚡"
TitleLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
TitleLabel.TextStrokeTransparency = 0.5
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 20
TitleLabel.Parent = ScreenGui

-- Label: hiển thị coin
local CoinsLabel = Instance.new("TextLabel")
CoinsLabel.Size = UDim2.new(0, 200, 0, 30)
CoinsLabel.Position = UDim2.new(0, 10, 0, 60)
CoinsLabel.BackgroundTransparency = 1
CoinsLabel.Text = "Beachballs: Loading..."
CoinsLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
CoinsLabel.Font = Enum.Font.Gotham
CoinsLabel.TextSize = 18
CoinsLabel.Parent = ScreenGui

-- Update coin count
task.spawn(function()
    while true do
        local success, err = pcall(function()
            local profileData = ReplicatedStorage.Remotes.Inventory.GetProfileData:InvokeServer()
            if profileData and profileData.Coins then
                local currentCoins = tostring(profileData.Materials.Owned.BeachBalls2025)
                CoinsLabel.Text = "Beachballs: " .. currentCoins
            end
        end)

        if not success then
            CoinsLabel.Text = "Beachballs: Error"
        end
        task.wait(2)
    end
end)

-- ===================================================================
-- Core logic
-- ===================================================================

local isSafe = false
local circleMovementConnection = nil
local currentCoinCenter = nil
local currentMurder = nil

local function findMurder()
    for _, p in ipairs(Players:GetPlayers()) do
        if p == localPlayer then continue end
        if (p.Backpack and p.Backpack:FindFirstChild("Knife")) or (p.Character and p.Character:FindFirstChild("Knife")) then
            return p
        end
    end
    return nil
end

local function isBagFull()
    local success, result = pcall(function()
        return PlayerGui.MainGUI.Game.CoinBags.Container.Coin.CurrencyFrame.Icon.Coins.Text
    end)
    if success and result then
        local current = tonumber(result)
        return current and current >= 40
    end
    return false
end

local function teleportTo(targetCFrame)
    local character = localPlayer.Character
    if character and character:FindFirstChild('HumanoidRootPart') then
        character.HumanoidRootPart.CFrame = targetCFrame
        return true
    end
    return false
end

local function startCircleMovement(centerPosition)
    if circleMovementConnection then
        circleMovementConnection:Disconnect()
    end
    currentCoinCenter = centerPosition
    local angle = 0
    local radius = 0.5
    local speed = 2

    circleMovementConnection = RunService.Heartbeat:Connect(function(dt)
        local character = localPlayer.Character
        if character and character:FindFirstChild('HumanoidRootPart') and currentCoinCenter then
            angle = angle + speed * dt
            local x = currentCoinCenter.X + math.cos(angle) * radius
            local z = currentCoinCenter.Z + math.sin(angle) * radius
            character.HumanoidRootPart.CFrame = CFrame.new(x, currentCoinCenter.Y, z)
        end
    end)
end

local function stopCircleMovement()
    if circleMovementConnection then
        circleMovementConnection:Disconnect()
        circleMovementConnection = nil
    end
    currentCoinCenter = nil
end

local function flyToSafety()
    local character = localPlayer.Character
    if character and character:FindFirstChild('HumanoidRootPart') then
        local currentPos = character.HumanoidRootPart.Position
        local safePos = Vector3.new(currentPos.X, currentPos.Y + configs.safeHeight, currentPos.Z)
        character.HumanoidRootPart.CFrame = CFrame.new(safePos)
        isSafe = true
        stopCircleMovement()
    end
end

local function returnToGround()
    local character = localPlayer.Character
    if character and character:FindFirstChild('HumanoidRootPart') then
        local raycast = Workspace:Raycast(character.HumanoidRootPart.Position, Vector3.new(0, -1000, 0))
        if raycast then
            local groundPos = raycast.Position + Vector3.new(0, 5, 0)
            character.HumanoidRootPart.CFrame = CFrame.new(groundPos)
        end
        isSafe = false
    end
end

-- Auto reset
task.spawn(function()
    while configs.enableAutoReset do
        task.wait(configs.resetInterval)
        if localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid") then
            localPlayer.Character.Humanoid.Health = 0
        end
    end
end)

-- Coin farm
local coinFarmConnection = nil
local function coinFarm()
    if coinFarmConnection then coinFarmConnection:Disconnect() end

    coinFarmConnection = RunService.Heartbeat:Connect(function()
        if not localPlayer:GetAttribute("Alive") then
            return
        end
        if isBagFull() then
            flyToSafety()
            return
        end

        local coins = CollectionService:GetTagged("Coin")
        if #coins > 0 then
            local closestCoin = nil
            local closestDistance = math.huge
            local myPos = localPlayer.Character.HumanoidRootPart.Position
            for _, coin in ipairs(coins) do
                local dist = (coin.Position - myPos).Magnitude
                if dist < closestDistance then
                    closestDistance = dist
                    closestCoin = coin
                end
            end

            if closestCoin then
                if teleportTo(closestCoin.CFrame) then
                    startCircleMovement(closestCoin.Position)
                    task.wait(configs.coinWaitTime)
                    stopCircleMovement()
                end
            end
        else
            stopCircleMovement()
        end
    end)
end

-- ===================================================================
-- Main loop
-- ===================================================================

task.spawn(function()
    while true do
        currentMurder = findMurder()
        local distanceToMurder = currentMurder and (localPlayer.Character.HumanoidRootPart.Position - currentMurder.Character.HumanoidRootPart.Position).Magnitude or math.huge

        if distanceToMurder < configs.murderDistance then
            if not isSafe then
                flyToSafety()
            end
        else
            if isSafe then
                returnToGround()
            end
        end

        if not isSafe then
            coinFarm()
        else
            stopCircleMovement()
        end

        task.wait(configs.loopDelay)
    end
end)
