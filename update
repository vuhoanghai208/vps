--===[ MM2 Auto Farm + Safe Spots (Random/Nearest/Height Fallback) ]===--

repeat task.wait() until game:IsLoaded()
if getgenv().MyMM2ScriptUI then return end
getgenv().MyMM2ScriptUI = true

--========================
-- CONFIG
--========================
getgenv().configs = getgenv().configs or {
    coinFarm        = true,             -- Bật/Tắt farm coin
    murderDistance  = 30,               -- Khoảng cách phát hiện murderer để trốn
    coinWaitTime    = 2,                -- Đợi sau khi tele tới coin
    loopDelay       = 0.4,              -- Độ trễ vòng lặp chính
    safeWaitTime    = 2,                -- Thời gian nấp ở safe spot
    resetInterval   = 300,              -- Khoảng reset
    enableAutoReset = false,            -- Bật/Tắt auto reset
    coinNames       = {"Coin_Server"},  -- Tên đối tượng coin trong Workspace

    -- Ẩn náu: chọn 1 chế độ "random" | "nearest" | "height"
    safeMode        = "random",
    safeHeight      = 100,              -- Dự phòng: bay lên cao nếu thiếu safe spot
    safeSpots       = {                 -- Điểm nấp (tường/góc), hãy điền theo map bạn chơi
        Vector3.new(-20, 5, 50),
        Vector3.new(100, 6, -40),
        Vector3.new(-120, 4, 80),
        Vector3.new(42, 7, 133),
        Vector3.new(-75, 5, -95)
    },

    -- Tối ưu chuyển động quanh coin
    orbitRadius     = 0.6,
    orbitSpeed      = 2.2
}

--========================
-- Services & State
--========================
local Players     = game:GetService("Players")
local RunService  = game:GetService("RunService")
local RS          = RunService
local Replicated  = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local processedCoins   = {}
local currentMurder    = nil
local isSafe           = false
local circleMovement   = nil
local currentCoinCenter= nil
local lastSafeSpot     = nil

--========================
-- UI + Render Toggle
--========================
pcall(function() RS:Set3dRenderingEnabled(false) end)

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Name = "TheaugHub_MM2"

local BlackFrame = Instance.new("Frame")
BlackFrame.Parent = ScreenGui
BlackFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BlackFrame.BorderSizePixel = 0
BlackFrame.Size = UDim2.new(1, 0, 1, 0)
BlackFrame.ZIndex = -1

local LogoFrame = Instance.new("Frame")
LogoFrame.Parent = ScreenGui
LogoFrame.BackgroundTransparency = 1
LogoFrame.Size = UDim2.new(0, 600, 0, 180)
LogoFrame.Position = UDim2.new(0.5, -300, 0.5, -90)
LogoFrame.ZIndex = 10

local MainTitle = Instance.new("TextLabel")
MainTitle.Parent = LogoFrame
MainTitle.BackgroundTransparency = 1
MainTitle.Size = UDim2.new(1, 0, 0.5, 0)
MainTitle.Text = "Theaug Hub"
MainTitle.TextColor3 = Color3.fromRGB(0, 255, 255)
MainTitle.TextScaled = true
MainTitle.Font = Enum.Font.GothamBold
MainTitle.TextStrokeTransparency = 0
MainTitle.TextStrokeColor3 = Color3.fromRGB(255, 255, 255)
MainTitle.ZIndex = 11

local SubTitle = Instance.new("TextLabel")
SubTitle.Parent = LogoFrame
SubTitle.BackgroundTransparency = 1
SubTitle.Size = UDim2.new(1, 0, 0.2, 0)
SubTitle.Position = UDim2.new(0, 0, 0.5, 0)
SubTitle.Text = "Murder Mystery 2"
SubTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
SubTitle.TextScaled = true
SubTitle.Font = Enum.Font.Gotham
SubTitle.ZIndex = 11

local CoinsLabel = Instance.new("TextLabel")
CoinsLabel.Parent = LogoFrame
CoinsLabel.BackgroundTransparency = 1
CoinsLabel.Size = UDim2.new(1, 0, 0.23, 0)
CoinsLabel.Position = UDim2.new(0, 0, 0.7, 10)
CoinsLabel.Text = "Beachballs: Loading..."
CoinsLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
CoinsLabel.Font = Enum.Font.Gotham
CoinsLabel.TextScaled = true
CoinsLabel.ZIndex = 11

local RenderButton = Instance.new("TextButton")
RenderButton.Parent = ScreenGui
RenderButton.Size = UDim2.new(0, 80, 0, 80)
RenderButton.Position = UDim2.new(0, 50, 0.5, -40)
RenderButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
RenderButton.BorderSizePixel = 2
RenderButton.BorderColor3 = Color3.fromRGB(0, 255, 255)
RenderButton.Text = "3D\nOFF"
RenderButton.TextColor3 = Color3.fromRGB(255, 255, 255)
RenderButton.TextScaled = true
RenderButton.Font = Enum.Font.GothamBold
RenderButton.ZIndex = 12

local isUIVisible = true
RenderButton.MouseButton1Click:Connect(function()
    isUIVisible = not isUIVisible
    if isUIVisible then
        pcall(function() RS:Set3dRenderingEnabled(false) end)
        BlackFrame.Visible = true
        LogoFrame.Visible = true
        RenderButton.Text = "3D\nOFF"
        RenderButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    else
        pcall(function() RS:Set3dRenderingEnabled(true) end)
        BlackFrame.Visible = false
        LogoFrame.Visible = false
        RenderButton.Text = "3D\nON"
        RenderButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    end
end)

-- Ẩn các UI khác (giữ sạch màn hình)
local function cleanupOtherUIs()
    pcall(function()
        game:GetService("StarterGui"):SetCoreGuiEnabled(Enum.CoreGuiType.All, false)
        for _, gui in pairs(LocalPlayer.PlayerGui:GetChildren()) do
            if gui ~= ScreenGui and gui.Name ~= "TheaugHub_MM2" then
                pcall(function() gui.Enabled = false end)
            end
        end
        for _, gui in pairs(game:GetService("CoreGui"):GetChildren()) do
            pcall(function() gui.Enabled = false end)
        end
    end)
end

task.spawn(function()
    while task.wait(1) do cleanupOtherUIs() end
end)

-- Auto chọn thiết bị nếu có
task.spawn(function()
    repeat task.wait() until Players.LocalPlayer and Players.LocalPlayer.PlayerGui
    local pg = Players.LocalPlayer.PlayerGui
    while pg:FindFirstChild("DeviceSelect") do
        for _, v in pairs(getconnections(pg.DeviceSelect.Container.Phone.Button.MouseButton1Click)) do
            pcall(function() v:Fire() end)
        end
        task.wait(0.25)
    end
end)

-- Cập nhật coin hiển thị
task.spawn(function()
    while task.wait(2) do
        local ok = pcall(function()
            local profileData = Replicated.Remotes.Inventory.GetProfileData:InvokeServer()
            if profileData and profileData.Materials and profileData.Materials.Owned then
                CoinsLabel.Text = "Beachballs: " .. tostring(profileData.Materials.Owned.BeachBalls2025 or 0)
            end
        end)
        if not ok then
            CoinsLabel.Text = "Beachballs: Error"
        end
    end
end)

--========================
-- Utilities
--========================
local function getHRP(char) return char and char:FindFirstChild("HumanoidRootPart") end

local function teleportTo(cf)
    local char = LocalPlayer.Character
    local hrp = getHRP(char)
    if hrp then
        hrp.CFrame = cf
        return true
    end
    return false
end

local function isBagFull()
    local ok, txt = pcall(function()
        return LocalPlayer.PlayerGui.MainGUI.Game.CoinBags.Container.Coin.CurrencyFrame.Icon.Coins.Text
    end)
    if ok and txt then
        local n = tonumber(txt)
        return n and n >= 40
    end
    return false
end

-- Orbit quanh coin để nhặt ổn định
local function startCircleMovement(centerPosition)
    if circleMovement then circleMovement:Disconnect() end
    currentCoinCenter = centerPosition
    local angle, radius, speed = 0, getgenv().configs.orbitRadius, getgenv().configs.orbitSpeed
    circleMovement = RS.Heartbeat:Connect(function()
        local char = LocalPlayer.Character
        local hrp = getHRP(char)
        if hrp and currentCoinCenter then
            angle += speed * 0.1
            local x = currentCoinCenter.X + math.cos(angle) * radius
            local z = currentCoinCenter.Z + math.sin(angle) * radius
            hrp.CFrame = CFrame.new(x, currentCoinCenter.Y, z)
        end
    end)
end

local function stopCircleMovement()
    if circleMovement then circleMovement:Disconnect() circleMovement = nil end
    currentCoinCenter = nil
end

-- Tìm murderer
local function findMurder()
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            local knife = (p.Backpack and p.Backpack:FindFirstChild("Knife")) or (p.Character and p.Character:FindFirstChild("Knife"))
            if knife then return p end
        end
    end
    return nil
end

local function getDistanceToMurder()
    if not currentMurder or not currentMurder.Character then return math.huge end
    local myChar = LocalPlayer.Character
    local myHRP  = getHRP(myChar)
    local murHRP = getHRP(currentMurder.Character)
    if not myHRP or not murHRP then return math.huge end
    return (myHRP.Position - murHRP.Position).Magnitude
end

-- Safe spot selection
local function getNearestSafeSpot()
    local char = LocalPlayer.Character
    local hrp  = getHRP(char)
    if not hrp then return nil end
    local myPos = hrp.Position
    local nearest, dist = nil, math.huge
    for _, spot in ipairs(getgenv().configs.safeSpots) do
        local d = (myPos - spot).Magnitude
        if d < dist then dist, nearest = d, spot end
    end
    return nearest
end

local function getRandomSafeSpot()
    local spots = getgenv().configs.safeSpots
    if #spots == 0 then return nil end
    local pick
    for i = 1, 5 do
        local idx = math.random(1, #spots)
        pick = spots[idx]
        if not lastSafeSpot or (pick - lastSafeSpot).Magnitude > 2 then break end
    end
    -- Jitter nhỏ để tránh chồng vị trí
    local jitter = Vector3.new(math.random(-50,50)/100, 0, math.random(-50,50)/100)
    return pick + jitter
end

local function flyToSafety()
    local mode = (getgenv().configs.safeMode or "random"):lower()
    local char = LocalPlayer.Character
    local hrp  = getHRP(char)
    if not hrp then return end

    local targetPos
    if mode == "nearest" then
        targetPos = getNearestSafeSpot()
    elseif mode == "random" then
        targetPos = getRandomSafeSpot()
    end

    if targetPos then
        lastSafeSpot = targetPos
        teleportTo(CFrame.new(targetPos) * CFrame.Angles(0, math.rad(math.random(0,359)), 0))
    else
        -- Fallback: bay lên cao (height)
        local p = hrp.Position
        teleportTo(CFrame.new(p.X, getgenv().configs.safeHeight, p.Z))
    end

    isSafe = true
    stopCircleMovement()
end

local function returnToGround()
    local char = LocalPlayer.Character
    local hrp  = getHRP(char)
    if not hrp then return end
    local result = workspace:Raycast(hrp.Position, Vector3.new(0, -1000, 0))
    if result then
        teleportTo(CFrame.new(result.Position + Vector3.new(0, 5, 0)))
    end
    isSafe = false
end

-- Auto reset
local function autoReset()
    while getgenv().configs.enableAutoReset do
        task.wait(getgenv().configs.resetInterval)
        local char = LocalPlayer.Character
        local hum  = char and char:FindFirstChild("Humanoid")
        if hum then hum.Health = 0 end
    end
end

-- Tìm coin
local function findCoins()
    local coins = {}
    local names = getgenv().configs.coinNames
    local nameSet = {}
    for _, n in ipairs(names) do nameSet[n] = true end

    local function scan(parent)
        for _, child in ipairs(parent:GetChildren()) do
            if child:IsA("BasePart") and nameSet[child.Name] and not processedCoins[child] then
                table.insert(coins, child)
            end
            scan(child)
        end
    end
    scan(workspace)
    return coins
end

-- Cleanup coin đã biến mất
task.spawn(function()
    while task.wait(10) do
        for coin in pairs(processedCoins) do
            if not coin or not coin.Parent then
                processedCoins[coin] = nil
            end
        end
    end
end)

--========================
-- CORE LOOP
--========================
local function coinFarm()
    while getgenv().configs.coinFarm and task.wait(getgenv().configs.loopDelay) do
        currentMurder = findMurder()
        local dist = getDistanceToMurder()

        -- Nếu chết/không alive → bỏ qua vòng
        if not LocalPlayer:GetAttribute("Alive") then continue end

        -- Túi đầy → nấp
        if isBagFull() then
            if not isSafe then flyToSafety() end
            continue
        end

        -- Murderer gần → nấp
        if dist < getgenv().configs.murderDistance then
            if not isSafe then
                flyToSafety()
                task.wait(getgenv().configs.safeWaitTime)
            end
        else
            if isSafe then
                returnToGround()
                task.wait(0.5)
            end
        end

        -- Ăn coin
        if not isSafe then
            local coins = findCoins()
            if #coins > 0 then
                local target = coins[1]
                processedCoins[target] = true
                if teleportTo(target.CFrame) then
                    startCircleMovement(target.Position)
                    task.wait(getgenv().configs.coinWaitTime)
                end
                task.delay(2, function() processedCoins[target] = nil end)
            else
                stopCircleMovement()
            end
        end
    end
end

task.spawn(autoReset)
task.spawn(coinFarm)
